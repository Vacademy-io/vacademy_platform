# Instructor Copilot Feature

## Overview
The **Instructor Copilot** feature empowers instructors by automating the creation of structured educational content from class transcripts. By leveraging LLM (Large Language Model) capabilities via the OpenRouter API, the system automatically generates titles, summaries, flashcards, and flashnotes.

## Components

### 1. Data Model (`entity/InstructorCopilotLog.java`)
- **Table**: `instructor_copilot_logs`
- **Fields**:
  - `id`: Unique identifier (UUID).
  - `transcript_json`: Input transcript provided by the instructor.
  - `title`, `summary`, `flashcard_json`, `flashnotes_json`: Content generated by the LLM.
  - `thumbnail_file_id`, `question_json`, `slides_json`, `video_json`: Additional fields for future expansion/manual entry.
  - `status`: Lifecycle status (`ACTIVE`, `DELETED`).

### 2. Service Layer
- **`InstructorCopilotService.java`**:
  - Manages the lifecycle of copilot logs (Create, Update, Delete, List, Retry).
  - Handles asynchronous content generation. Upon creation, a background task is triggered to call the LLM service.
  - Provides a retry mechanism for failed content generation attempts.
- **`InstructorCopilotLLMService.java`**:
  - Interacts with the **OpenRouter API**.
  - **Multi-Model Fallback Strategy**: Implements a cascading retry approach for resilience:
    1. **Primary Model**: `xiaomi/mimo-v2-flash:free` (2 retries)
    2. **Fallback Model 1**: `mistralai/devstral-2512:free` (2 retries)
    3. **Fallback Model 2**: `nvidia/nemotron-3-nano-30b-a3b:free` (0 retries - final attempt)
  - **Logic**: Sends the transcript with a prompt enforcing a strict JSON response format.
  - **Resilience**: Each model attempt includes retry logic with 2-second delays between retries.

### 3. API Endpoints (`controller/InstructorCopilotController.java`)
| Method | Endpoint | Description |
| :--- | :--- | :--- |
| `POST` | `/admin-core-service/instructor-copilot/v1/create` | Creates a log and triggers async generation. |
| `POST` | `/admin-core-service/instructor-copilot/v1/retry-generate/{id}` | Retries content generation for an existing log. |
| `PATCH` | `/admin-core-service/instructor-copilot/v1/{id}` | Updates specific fields of a log. |
| `DELETE` | `/admin-core-service/instructor-copilot/v1/{id}` | Soft deletes a log. |
| `GET` | `/admin-core-service/instructor-copilot/v1/list` | Lists logs filtered by institute, status, and date range. |

## Configuration
- **Environment Variable**: `OPENROUTER_API_KEY` must be set in the application properties (e.g., `application-stage.properties`).

## Workflow
1. **Input**: Instructor submits a transcript via the Create API.
2. **Persistence**: A log record is created with status `ACTIVE`.
3. **Async Generation**: The system asynchronously sends the transcript to the LLM.
4. **Update**: Once the LLM responds, the specific log entry is updated with the generated content (Title, Summary, Flashcards, Flashnotes).
5. **Retrieval**: The instructor can retrieve the processed content via the List API.

## Sample cURLs

### 1. Create Log (and Trigger Generation)
```bash
curl -X POST "http://localhost:8080/admin-core-service/instructor-copilot/v1/create?instituteId=inst_123" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <YOUR_TOKEN>" \
  -d '{
    "transcript_json": "Instructor: Today we are learning about Photosynthesis..."
  }'
```

### 2. List Logs (Filter by Date & Status)
```bash
curl -X GET "http://localhost:8080/admin-core-service/instructor-copilot/v1/list?instituteId=inst_123&status=ACTIVE&startDate=2023-10-01&endDate=2023-10-31" \
  -H "Authorization: Bearer <YOUR_TOKEN>"
```

### 3. Update Log
```bash
curl -X PATCH "http://localhost:8080/admin-core-service/instructor-copilot/v1/<LOG_ID>" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <YOUR_TOKEN>" \
  -d '{
    "title": "New Title for Class",
    "status": "ACTIVE"
  }'
```

### 4. Delete Log (Soft Delete)
```bash
curl -X DELETE "http://localhost:8080/admin-core-service/instructor-copilot/v1/<LOG_ID>" \
  -H "Authorization: Bearer <YOUR_TOKEN>"
```
